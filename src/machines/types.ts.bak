/**
 * Budget Machine Types
 * Complete type definitions for the xstate FSM
 */

import type { TelegramWebAppUser } from '../types/telegram';
import type { AccountUsage, CategoryUsage, DestinationSuggestion } from '../services/sync';
import type { DisplayTransaction, TransactionData } from '../types/transaction';

// ============================================================================
// User & Auth Types
// ============================================================================

export interface BudgetUser {
  id: number;
  user_name: string;
  fullName: string;
  photoUrl: string | null;
  initials: string;
  bio: string;
  colorScheme: 'light' | 'dark';
  rawUser: TelegramWebAppUser | null;
}

// ============================================================================
// Transaction Form Types
// ============================================================================

export interface TransactionForm {
  account: string;
  amount: string;
  category: string;
  category_id: number;
  budget_name: string;
  notes: string;
  destination_name: string;
  destination_id: number;
  account_id: string;
  account_currency: string;
  user_id: number | undefined;
  user_name: string;
  amount_eur: string;
  // UI State for withdrawal flow
  conversionAmount: number | null;
  isLoadingConversion: boolean;
  suggestions: DestinationSuggestion[];
  isLoadingSuggestions: boolean;
  suggestionsError: string | null;
  isSubmitting: boolean;
  submitMessage: { type: 'success' | 'error'; text: string } | null;
}

export const initialTransactionForm: TransactionForm = {
  account: '',
  amount: '',
  category: '',
  category_id: 0,
  budget_name: '',
  notes: '',
  destination_name: '',
  destination_id: 0,
  account_id: '',
  account_currency: '',
  user_id: undefined,
  user_name: '',
  amount_eur: '',
  conversionAmount: null,
  isLoadingConversion: false,
  suggestions: [],
  isLoadingSuggestions: false,
  suggestionsError: null,
  isSubmitting: false,
  submitMessage: null,
};

// ============================================================================
// Transfer Flow Types
// ============================================================================

export interface TransferAccount {
  account: string;
  id: string;
  currency: string;
}

export interface TransferForm {
  source: TransferAccount;
  destination: TransferAccount;
  exitAmount: string;
  entryAmount: string;
  exitFee: string;
  entryFee: string;
  notes: string;
}

export const initialTransferForm: TransferForm = {
  source: { account: '', id: '', currency: '' },
  destination: { account: '', id: '', currency: '' },
  exitAmount: '',
  entryAmount: '',
  exitFee: '',
  entryFee: '',
  notes: '',
};

// ============================================================================
// UI State Types
// ============================================================================

export interface ResourceLoadingState {
  loading: boolean;
  error: string | null;
}

export interface UIState {
  accounts: ResourceLoadingState;
  categories: ResourceLoadingState;
  transactions: ResourceLoadingState;
  services: {
    telegram: ServiceStatus;
    sync: ServiceStatus;
    firefly: ServiceStatus;
  };
}

export interface ServiceStatus {
  name: string;
  status: 'checking' | 'connected' | 'disconnected';
  message: string;
}

export const initialUIState: UIState = {
  accounts: { loading: false, error: null },
  categories: { loading: false, error: null },
  transactions: { loading: false, error: null },
  services: {
    telegram: { name: 'Telegram SDK', status: 'checking', message: 'Initializing...' },
    sync: { name: 'Sync API', status: 'checking', message: 'Initializing...' },
    firefly: { name: 'Firefly API', status: 'checking', message: 'Initializing...' },
  },
};

// ============================================================================
// Selected Transaction Types
// ============================================================================

export interface SelectedTransactionState {
  id: string | null;
  rawData: TransactionData | null;
  editing: DisplayTransaction | null;
}

export const initialSelectedTransaction: SelectedTransactionState = {
  id: null,
  rawData: null,
  editing: null,
};

// ============================================================================
// Data Types
// ============================================================================

export interface DataState {
  accounts: AccountUsage[];
  categories: CategoryUsage[];
  transactions: DisplayTransaction[];
}

export const initialDataState: DataState = {
  accounts: [],
  categories: [],
  transactions: [],
};

// ============================================================================
// Machine Context
// ============================================================================

export interface BudgetMachineContext {
  user: BudgetUser;
  transaction: TransactionForm;
  transfer: TransferForm;
  data: DataState;
  ui: UIState;
  selectedTransaction: SelectedTransactionState;
}

export const initialContext: BudgetMachineContext = {
  user: {
    id: 0,
    user_name: 'Guest',
    fullName: 'Guest',
    photoUrl: null,
    initials: 'G',
    bio: 'Manage finances and create reports',
    colorScheme: 'dark',
    rawUser: null,
  },
  transaction: initialTransactionForm,
  transfer: initialTransferForm,
  data: initialDataState,
  ui: initialUIState,
  selectedTransaction: initialSelectedTransaction,
};

// ============================================================================
// Machine Events
// ============================================================================

// Initialization Events
export type InitEvent =
  | { type: 'INIT_START' }
  | { type: 'INIT_DONE'; data: { user: BudgetUser } }
  | { type: 'INIT_ERROR'; error: string };

// Navigation Events
export type NavigationEvent =
  | { type: 'NAVIGATE_HOME' }
  | { type: 'NAVIGATE_WITHDRAWAL_ACCOUNTS' }
  | { type: 'NAVIGATE_INCOME_ACCOUNTS' }
  | { type: 'NAVIGATE_AMOUNT' }
  | { type: 'NAVIGATE_CATEGORY' }
  | { type: 'NAVIGATE_COMMENT' }
  | { type: 'NAVIGATE_CONFIRM' }
  | { type: 'NAVIGATE_TRANSFER_SOURCE' }
  | { type: 'NAVIGATE_TRANSFER_DEST' }
  | { type: 'NAVIGATE_TRANSFER_AMOUNT' }
  | { type: 'NAVIGATE_TRANSFER_FEES' }
  | { type: 'NAVIGATE_TRANSFER_COMMENT' }
  | { type: 'NAVIGATE_TRANSFER_CONFIRM' }
  | { type: 'NAVIGATE_TRANSACTIONS' }
  | { type: 'NAVIGATE_TRANSACTION_DETAIL' }
  | { type: 'NAVIGATE_TRANSACTION_EDIT' }
  | { type: 'NAVIGATE_DEBUG' }
  | { type: 'NAVIGATE_BACK' };

// Transaction Form Events
export type TransactionEvent =
  | { type: 'UPDATE_ACCOUNT'; account: string; account_id: string; account_currency: string; user_name: string }
  | { type: 'UPDATE_AMOUNT'; amount: string }
  | { type: 'UPDATE_AMOUNT_EUR'; amount_eur: string }
  | { type: 'UPDATE_CATEGORY'; category: string; category_id?: number; budget_name?: string }
  | { type: 'UPDATE_NOTES'; notes: string; destination_id?: number }
  | { type: 'RESET_TRANSACTION' }
  | { type: 'SET_USER_DATA'; user_id: number; user_name: string }
  | { type: 'SELECT_TRANSACTION'; id: string }
  | { type: 'CLEAR_SELECTED_TRANSACTION' }
  // UI state events for withdrawal flow
  | { type: 'SET_CONVERSION_AMOUNT'; amount_eur: number }
  | { type: 'SET_IS_LOADING_CONVERSION'; isLoading: boolean }
  | { type: 'SET_SUGGESTIONS'; suggestions: DestinationSuggestion[] }
  | { type: 'SET_IS_LOADING_SUGGESTIONS'; isLoading: boolean }
  | { type: 'SET_SUGGESTIONS_ERROR'; error: string | null }
  | { type: 'SET_IS_SUBMITTING'; isSubmitting: boolean }
  | { type: 'SET_SUBMIT_MESSAGE'; message: { type: 'success' | 'error'; text: string } | null };

// Transfer Events
export type TransferEvent =
  | { type: 'SET_TRANSFER_SOURCE'; account: string; id: string; currency: string }
  | { type: 'SET_TRANSFER_DEST'; account: string; id: string; currency: string }
  | { type: 'UPDATE_TRANSFER_EXIT_AMOUNT'; amount: string }
  | { type: 'UPDATE_TRANSFER_ENTRY_AMOUNT'; amount: string }
  | { type: 'UPDATE_TRANSFER_EXIT_FEE'; fee: string }
  | { type: 'UPDATE_TRANSFER_ENTRY_FEE'; fee: string }
  | { type: 'UPDATE_TRANSFER_NOTES'; notes: string }
  | { type: 'RESET_TRANSFER' };

// Data Fetch Events
export type DataEvent =
  | { type: 'FETCH_ACCOUNTS' }
  | { type: 'FETCH_ACCOUNTS_SUCCESS'; accounts: AccountUsage[] }
  | { type: 'FETCH_ACCOUNTS_ERROR'; error: string }
  | { type: 'FETCH_CATEGORIES' }
  | { type: 'FETCH_CATEGORIES_SUCCESS'; categories: CategoryUsage[] }
  | { type: 'FETCH_CATEGORIES_ERROR'; error: string }
  | { type: 'FETCH_TRANSACTIONS' }
  | { type: 'FETCH_TRANSACTIONS_SUCCESS'; transactions: DisplayTransaction[] }
  | { type: 'FETCH_TRANSACTIONS_ERROR'; error: string };

// Service Status Events
export type ServiceEvent =
  | { type: 'CHECK_SERVICES' }
  | { type: 'SERVICE_STATUS_CHANGED'; service: keyof UIState['services']; status: ServiceStatus }
  | { type: 'TELEGRAM_READY' }
  | { type: 'SYNC_CONNECTED' }
  | { type: 'FIREFLY_CONNECTED' };

// Submission Events
export type SubmissionEvent =
  | { type: 'SUBMIT_TRANSACTION' }
  | { type: 'SUBMIT_TRANSACTION_SUCCESS' }
  | { type: 'SUBMIT_TRANSACTION_ERROR'; error: string }
  | { type: 'SUBMIT_TRANSFER' }
  | { type: 'SUBMIT_TRANSFER_SUCCESS' }
  | { type: 'SUBMIT_TRANSFER_ERROR'; error: string }
  | { type: 'EDIT_TRANSACTION'; transaction: TransactionData }
  | { type: 'DELETE_TRANSACTION' }
  | { type: 'DELETE_TRANSACTION_SUCCESS' }
  | { type: 'DELETE_TRANSACTION_ERROR'; error: string };

// All Events
export type BudgetMachineEvent =
  | InitEvent
  | NavigationEvent
  | TransactionEvent
  | TransferEvent
  | DataEvent
  | ServiceEvent
  | SubmissionEvent;

// ============================================================================
// TypeScript Discriminated Union Helpers
// ============================================================================

export const isTransactionEvent = (event: BudgetMachineEvent): event is TransactionEvent => {
  return [
    'UPDATE_ACCOUNT',
    'UPDATE_AMOUNT',
    'UPDATE_AMOUNT_EUR',
    'UPDATE_CATEGORY',
    'UPDATE_NOTES',
    'RESET_TRANSACTION',
    'SET_USER_DATA',
    'SELECT_TRANSACTION',
    'CLEAR_SELECTED_TRANSACTION',
    'SET_CONVERSION_AMOUNT',
    'SET_IS_LOADING_CONVERSION',
    'SET_SUGGESTIONS',
    'SET_IS_LOADING_SUGGESTIONS',
    'SET_SUGGESTIONS_ERROR',
    'SET_IS_SUBMITTING',
    'SET_SUBMIT_MESSAGE',
  ].includes(event.type as any);
};

export const isTransferEvent = (event: BudgetMachineEvent): event is TransferEvent => {
  return [
    'SET_TRANSFER_SOURCE',
    'SET_TRANSFER_DEST',
    'UPDATE_TRANSFER_EXIT_AMOUNT',
    'UPDATE_TRANSFER_ENTRY_AMOUNT',
    'UPDATE_TRANSFER_EXIT_FEE',
    'UPDATE_TRANSFER_ENTRY_FEE',
    'UPDATE_TRANSFER_NOTES',
    'RESET_TRANSFER',
  ].includes(event.type as any);
};
